<HTML>
	<head>
			<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	</head>
  <BODY>
	<h2>Browse Items And Select</h2>
	<table>
		{% for item in item_list %}
			<tr>
				<td><input type="checkbox" id="{{ item.id }}" data-name="{{ item.name }}" data-weight='{{ item.weight }}'/></td>
				<td>{{ item.id }}</td>
				<td>{{ item.name }}</td>
				<td>{{ item.category.name }}</td>
				<td>{{ item.weight }} kg</td>
				<td><img src="{{ item.image }}"/></td>
			</tr>
		{% endfor %}
	</table>

	<br>

	<div id="cart" >
		<h2>Cart</h2>
	</div>

	<br>
	<div id="showWeight">
		Maximum weight is 25 kg.<br>
		<p id="currentWeight"></p>
	</div>

	<br>

	<input id="submitButton" type="submit" value="Submit" class="show" />
	<p id="warning" class="hide">Your weight exceeds the Maximum loading capacity of the drone</p>

  </BODY>
</HTML>

<style>

	#warning {
		color: red;
	}

	div{
		border: 1px solid black;
	}

	table, th, td {
		border: 1px solid black;
	}

	button {
		background-color: orange; 
	}

	.hide {
		display: none;
	}

	.show {
		display: block;
	}

</style>

<script>

	// Ugly code mix up with js and jquery by Louis

	$(document).ready(function() {

		var maxWeight = 25;
		var currentWeight = 0;

		var cart = [];

		function addItem(id, name, weight){

			var item = {};
			item.id=id;
			item.weight=weight;
  			item.quantity=1;
			cart.push(item);
			
			currentWeight = currentWeight + weight;
			document.getElementById('currentWeight').innerHTML = 'Current weight is ' + currentWeight.toFixed(2) + ' kg';


			var itemDiv = document.createElement('div');
			itemDiv.id = 'cart-' + item.id;
			itemDiv.className = 'block';
			document.getElementById('cart').appendChild(itemDiv);
			
			var para = document.createElement("span");
			var node = document.createTextNode('Name: ' + name+' |                    ');
			para.appendChild(node);

			var element = document.getElementById('cart-' + item.id);
			element.appendChild(para);
			
			para = document.createElement("span");
			para.setAttribute('id', 'quantity-id-'+item.id);
			node = document.createTextNode('Quantity: '+ item.quantity);
			para.appendChild(node);
			
			element.appendChild(para);

			addButton = document.createElement("button");
			addButton.setAttribute('id', 'addButton-' + id);
			addButton.setAttribute('class', 'AddButton');
			addButton.setAttribute('data-item-id', id);
			addButton.innerHTML = '+';
			element.appendChild(addButton);

			deleteButton = document.createElement("button");
			deleteButton.setAttribute('id', 'deleteButton-' + id);
			deleteButton.setAttribute('class', 'DeleteButton');
			deleteButton.setAttribute('data-item-id', id);
			deleteButton.innerHTML = '-';
			element.appendChild(deleteButton);

		}

		$(document).on('click', '.AddButton', function () {
			
			var total = 0;
			var itemId = $(this).data("item-id");
			
			$.each(cart, function(i){
				if(cart[i].id == itemId) {
					cart[i].quantity += 1;
					currentWeight = currentWeight + cart[i].weight;
					document.getElementById('currentWeight').innerHTML = 'Current weight is ' + currentWeight.toFixed(2) + ' kg';
					total = cart[i].quantity;
					return false;
				}
			});

			document.getElementById('quantity-id-'+itemId).innerHTML = 'Quantity: ' + total;

			showSubmit();

		});

		$(document).on('click', '.DeleteButton', function () {
			
			var negativeWeight = false;
			var total = 0;
			var itemId = $(this).data("item-id");
			
			$.each(cart, function(i){
				if(cart[i].id == itemId) {
					cart[i].quantity -= 1;
					if(cart[i].quantity == 0){
						negativeWeight = true;
					}
					currentWeight = currentWeight - cart[i].weight;
					document.getElementById('currentWeight').innerHTML = 'Current weight is ' + currentWeight.toFixed(2) + ' kg';
					total = cart[i].quantity;
					return false;
				}
			});

			if(negativeWeight){
				$('#'+itemId).prop("checked", false);
				deleteItem(itemId);
			}else{
				document.getElementById('quantity-id-'+itemId).innerHTML = 'Quantity: ' + total;
			}

			showSubmit();

		});

		function deleteItem(id){

			$.each(cart, function(i){
				if(cart[i].id === id) {
					currentWeight = currentWeight - cart[i].weight * cart[i].quantity;
					document.getElementById('currentWeight').innerHTML = 'Current weight is ' + currentWeight.toFixed(10) + ' kg';
					cart.splice(i,1);
					return false;
				}
			});

			document.getElementById('cart-' + id).remove();

		}



		$('input:checkbox').click(function() {

			var isChecked = $(this).prop("checked");

			if(isChecked){
				addItem($(this).attr('id'), $(this).data('name'), parseFloat($(this).data('weight')));
			}else{
				deleteItem($(this).attr('id'));
			}
			showSubmit();

		});

		function showSubmit(){
			console.log(currentWeight);
			if(currentWeight > maxWeight){
				$('#warning').removeClass('hide').addClass('show');
				$('#submitButton').removeClass('show').addClass('hide');
			}else{
				$('#warning').removeClass('show').addClass('hide');
				$('#submitButton').removeClass('hide').addClass('show');
			}
		}
	
	});
</script>

